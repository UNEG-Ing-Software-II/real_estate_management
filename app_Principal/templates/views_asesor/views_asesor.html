{% extends 'base/base.html'%}

{% load static %}

{% block extra_styles %}
    <link rel="stylesheet" href="{% static '/styles/style.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
{% endblock %}

<!-- Botones dinámicos -->
{% block dynamic_button %}

  
{%endblock%}


{% block content %}

    <body id="Fondo">


    <div class="block-name">
        <h2 class="name-asesor">Bienvenido {{ request.user.rol }}  {{ request.user.nombre }}</h2>
    </div>

    <div class="d-fluid">
        <div class="buscador">
            <!--Buscador-->
            <input
                type="text"
                placeholder="Buscar Inmueble"
                class="form-control rounded-pill px-4 py-2 w-50"
            />
            <!--Icono-->
            <button type="button" class="d-fluid btn btn-secondary rounded-pill px-4 py-2">
                <i class='bx bx-search-alt'></i>Buscar
            </button>

            <!--Lupa-->
            <button type="button" class="d-fluid btn-secondary ocult">
                <i class='bx bx-search-alt lupa'></i>
            </button>
        </div>
    </div>

    <h1 class="mt-5 text-center text-light">Inmuebles:</h1>
    {% if inmuebles %}
        <div class="cards">
            <div class="row">
                {% for inmueble in inmuebles %}
                        <div class="col-12 col-sm-6 col-lg-4 mb-4   rule">
                            <div class="card bg-white">
                                <a href="{% url 'inmueble_detalles' inmueble.id %}">
                                <img
                                    src="{% static 'img/Inmueble1.jpeg' %}"
                                    alt="Exterior View"
                                    class="card-img-top"
                                />
                                <div class="card-body">
                                    <h3 class="card-title">{{inmueble.tipoPropiedad}}</h3>
                                    <h4>Propietario: NULL</h4>
                                    <h5 class="text-dark">ID propiedad: {{inmueble.id}}</h5>
                                </div>
                                </a>
                            </div>
                        </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <h2 class="text-center text-light">No hay inmuebles registrados (BD).</h2>
    {% endif %}

{% comment %} FIXME: Move map functionality to the base.html and eliminate view {% endcomment %}
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="InputMetrosTerreno" class="form-label">Metros² del terreno</label>
                            <input type="number" class="form-control" name="metros_terreno" id="InputMetrosTerreno" min="0.001" step="0.001" required>
                        </div>
                        <div class="col-md-6">
                            <label for="InputMetrosConstruccion" class="form-label">Metros² de construcción</label>
                            <input type="number" class="form-control" name="metros_construccion" id="InputMetrosConstruccion" min="0.001" step="0.001" required>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="bathroom" id="InputBathroom">
                                <label for="InputBathroom" class="form-check-label">Baño</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="cuarto_servicio" id="InputCuartoServicio">
                                <label for="InputCuartoServicio" class="form-check-label">Cuarto de servicio</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="oficina" id="InputOficina">
                                <label for="InputOficina" class="form-check-label">Oficina</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="estacionamiento" id="InputEstacionamiento">
                                <label for="InputEstacionamiento" class="form-check-label">Estacionamiento</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="half_bath" id="InputHalfBath">
                                <label for="InputHalfBath" class="form-check-label">Medio baño</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="terraza" id="InputTerraza">
                                <label for="InputTerraza" class="form-check-label">Terraza</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="habitacion" id="InputHabitacion">
                                <label for="InputHabitacion" class="form-check-label">Habitación</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="maletero" id="InputMaletero">
                                <label for="InputMaletero" class="form-check-label">Maletero</label>
                            </div>
                        </div>
                    </div>

                    <!-- Agregar coordenadas geográficas por escrito
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="InputLatitud" class="form-label mt-2">Latitud</label>
                            <input type="number" class="form-control" name="latitud" id="InputLatitud" min="-90" max="90" step="0.000001" required>
                         
                        </div>

                        <div class="col-md-6">
                            
                    <label for="InputLongitud" class="form-label mt-2">Longitud</label>
                    <input type="number" class="form-control" name="longitud" id="InputLongitud" min="-180" max="180" step="0.000001" required>
                
                        </div>
                    </div>                 
                    -->
                 
                    <label for="InputDirección" class="form-label mt-2">Dirección</label>
                    <input type="text" class="form-control" name="direccion" id="InputDireccion" required>
                    <br>

                    <div id="map"></div>
                    
                    <!-- Agregar coordenadas geográficas por mapa -->
                    <input type="hidden" id="InputLatitud" name="latitud" value="">
                    <input type="hidden" id="InputLongitud" name="longitud" value="">

                    <!--
                    <label for="InputImagen" class="form-label">Imagen de portada</label>
                    <input type="file" id="InputImagen" accept="image/*">
                    -->

                    <div class="modal-footer mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </div>
                </form>
                <script>
                    var map;
                    var currentMarker = null;
                
                    document.addEventListener('DOMContentLoaded', function() {
                        // Evento para mostrar el modal
                        var myModal = document.getElementById('ModalRegistroInmueble');
                        myModal.addEventListener('shown.bs.modal', function () {
                            if (!map) {
                                // Inicializa el mapa cuando se muestra el modal
                                map = L.map('map').setView([51.505, -0.09], 13);
                
                                // Añade el tile layer desde OpenStreetMap
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                }).addTo(map);
                
                                // Añade el geocodificador
                                var geocoder = L.Control.geocoder({
                                    defaultMarkGeocode: false
                                }).on('markgeocode', function(e) {
                                    var bbox = e.geocode.bbox;
                                    map.fitBounds([
                                        [bbox.getSouthWest().lat, bbox.getSouthWest().lng],
                                        [bbox.getNorthEast().lat, bbox.getNorthEast().lng]
                                    ]);
                                    var latlng = e.geocode.center;
                
                                    // Evento de clic en el mapa
                                    map.on('click', function(e) {
                                        // Elimina el marcador actual si existe
                                        if (currentMarker) {
                                            map.removeLayer(currentMarker);
                                        }
                
                                        // Agrega un nuevo marcador
                                        currentMarker = L.marker(e.latlng).addTo(map)
                                            .bindPopup(e.latlng.toString())
                                            .openPopup();
                
                                        // Muestra las coordenadas en la consola
                                        console.log('Latitud: ' + e.latlng.lat + ', Longitud: ' + e.latlng.lng);

                                        // Actualiza los valores del formulario
                                        document.getElementById('InputLatitud').value = e.latlng.lat;
                                        document.getElementById('InputLongitud').value = e.latlng.lng;
                                    });
                                }).addTo(map);
                            } else {
                                // Si el mapa ya fue inicializado, simplemente ajusta su tamaño
                                map.invalidateSize();
                            }
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</div>


{% endblock %}